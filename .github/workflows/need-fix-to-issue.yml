name: Need fix to issue

on:
  push:
    branches:
      - main

permissions: {}

jobs:
  need-fix:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
    steps:
      - uses: actions/checkout@v4

      - name: Find and close related issues
        uses: actions/github-script@v7
        with:
          script: |
            const commits = ${{ toJson(github.event.commits) }};
            const closePatterns = [
              /close[sd]?\s+#(\d+)/gi,
              /fix(?:e[sd])?\s+#(\d+)/gi,
              /resolve[sd]?\s+#(\d+)/gi
            ];

            for (const commit of commits) {
              for (const pattern of closePatterns) {
                let match;
                while ((match = pattern.exec(commit.message)) !== null) {
                  const issueNumber = parseInt(match[1]);
                  try {
                    await github.rest.issues.update({
                      owner: context.repo.owner,
                      repo: context.repo.repo,
                      issue_number: issueNumber,
                      state: 'closed'
                    });
                    console.log(`Closed issue #${issueNumber}`);
                  } catch (error) {
                    console.log(`Could not close issue #${issueNumber}: ${error.message}`);
                  }
                }
              }
            }
